# optional shell settings/config to source
################################################

# source the env vars prepped by phusion; it's automatically
# sourced by login shell, but login shell via ssh doesn't seem to be
# quite working for us, so let's manually source it:
source /etc/container_environment.sh

unalias deps build build-debug build-ib b bd r rd run run-debug brun bdrun src ib ibbuild >/dev/null 2>&1

# TODO: deprecated?
deps() {
    local e
    src || return 1
    nuget restore QuantConnect.Lean.sln
    e=$?
    popd > /dev/null
    return $e
}


_build() {
    local e
    src || return 1
    dotnet build QuantConnect.Lean.sln $1
    e=$?
    popd > /dev/null
    return $e
}


build() {
    _build '/property:Configuration=Release'
}


build-debug() {
    _build
}

build-ib() {
    local e
    ib || return 1
    dotnet build QuantConnect.InteractiveBrokersBrokerage.sln
    e=$?
    popd > /dev/null
    return $e
}

alias b='build'
alias bd='build-debug'
alias r='run'
alias rd='run-debug'
alias ibbuild='build-ib'


_run() {
    local rls e

    rls="$1"  # Debug | Release
    pushd "$SRC_MOUNT/Launcher/bin/$rls" > /dev/null || return 1
    dotnet QuantConnect.Lean.Launcher.dll < /dev/null  # do not let lean steal our stdin (Press any key...)
    e=$?
    popd > /dev/null
    return $e
}


run() {
    _run Release
}


run-debug() {
    _run Debug
}

brun() {
    build && run
}

bdrun() {
    build-debug && run-debug
}

src() {
    pushd -- "$SRC_MOUNT" > /dev/null
}

ib() {
    pushd -- "$IBKR_MOUNT" > /dev/null
}

ulimit -n 30000

